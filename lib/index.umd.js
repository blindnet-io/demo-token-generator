!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("crypto")):"function"==typeof define&&define.amd?define(["exports","crypto"],n):n((t="undefined"!=typeof globalThis?globalThis:t||self).blindnetTokenGenerator={},t.require$$0)}(this,(function(t,n){"use strict";function e(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var r=e(n),o=function(){return(o=Object.assign||function(t){for(var n,e=1,r=arguments.length;e<r;e++)for(var o in n=arguments[e])Object.prototype.hasOwnProperty.call(n,o)&&(t[o]=n[o]);return t}).apply(this,arguments)};
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */function i(t,n,e,r){return new(e||(e=Promise))((function(o,i){function s(t){try{c(r.next(t))}catch(t){i(t)}}function f(t){try{c(r.throw(t))}catch(t){i(t)}}function c(t){var n;t.done?o(t.value):(n=t.value,n instanceof e?n:new e((function(t){t(n)}))).then(s,f)}c((r=r.apply(t,n||[])).next())}))}function s(t,n){var e,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:f(0),throw:f(1),return:f(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function f(i){return function(f){return function(i){if(e)throw new TypeError("Generator is already executing.");for(;s;)try{if(e=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=n.call(t,s)}catch(t){i=[6,t],r=0}finally{e=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,f])}}}var f={};!function(t){
/*! noble-ed25519 - MIT License (c) Paul Miller (paulmillr.com) */
Object.defineProperty(t,"__esModule",{value:!0}),t.utils=t.verify=t.sign=t.getPublicKey=t.SignResult=t.Signature=t.Point=t.ExtendedPoint=t.CURVE=void 0;const n={a:-1n,d:37095705934669439343138083508754565189542113879843219016388785533085940283555n,P:2n**255n-19n,n:2n**252n+27742317777372353535851937790883648493n,h:8n,Gx:15112221349535400772501151409588531511454012693041857206046113283949847762202n,Gy:46316835694926478169428394003475163141307993866256225615783033603165251855960n};t.CURVE=n;const e=32,o=19681161376707505956807079304988542015446066515923890162744021073123829784752n,i=25063068953384623474111414158702152701244531502492656460079210482610430750235n,s=54469307008909316920995813868745141605393597292927456921205312896311721017578n,f=1159843021668779879193775521855586647937357759715417654439879720876111806838n,c=40440834346308536858101042469323190826248399146238708352240133220865137265952n;class u{constructor(t,n,e,r){this.x=t,this.y=n,this.z=e,this.t=r}static fromAffine(t){if(!(t instanceof l))throw new TypeError("ExtendedPoint#fromAffine: expected Point");return t.equals(l.ZERO)?u.ZERO:new u(t.x,t.y,1n,v(t.x*t.y))}static toAffineBatch(t){const e=function(t,e=n.P){const r=t.length,o=new Array(r);let i=1n;for(let n=0;n<r;n++)0n!==t[n]&&(o[n]=i,i=v(i*t[n],e));i=E(i,e);for(let n=r-1;n>=0;n--){if(0n===t[n])continue;let r=v(i*t[n],e);t[n]=v(i*o[n],e),i=r}return t}(t.map((t=>t.z)));return t.map(((t,n)=>t.toAffine(e[n])))}static normalizeZ(t){return this.toAffineBatch(t).map(this.fromAffine)}static fromRistrettoHash(t){const n=x(t.slice(0,e)),r=this.calcElligatorRistrettoMap(n),o=x(t.slice(e,64)),i=this.calcElligatorRistrettoMap(o);return r.add(i)}static calcElligatorRistrettoMap(t){const{d:e}=n,r=v(o*t*t),s=v((r+1n)*f);let a=-1n;const l=v((a-e*r)*v(r+e));let{isValid:d,value:h}=B(s,l),p=v(h*t);g(p)||(p=v(-p)),d||(h=p),d||(a=r);const y=v(a*(r-1n)*c-l),w=h*h,b=v((h+h)*l),m=v(y*i),x=v(1n-w),E=v(1n+w);return new u(v(b*E),v(x*m),v(m*E),v(b*x))}static fromRistrettoBytes(t){const{a:r,d:o}=n,i="ExtendedPoint.fromRistrettoBytes: Cannot convert bytes to Ristretto Point",s=x(t);if(!function(t,n){if(t.length!==n.length)return!1;for(let e=0;e<t.length;e++)if(t[e]!==n[e])return!1;return!0}(w(s,e),t)||g(s))throw new Error(i);const f=v(s*s),c=v(1n+r*f),a=v(1n-r*f),l=v(c*c),d=v(a*a),h=v(r*o*l-d),{isValid:p,value:y}=S(v(h*d)),b=v(y*a),m=v(y*b*h);let E=v((s+s)*b);g(E)&&(E=v(-E));const A=v(c*m),B=v(E*A);if(!p||g(B)||0n===A)throw new Error(i);return new u(E,A,1n,B)}toRistrettoBytes(){let{x:t,y:n,z:r,t:i}=this;const f=v((r+n)*(r-n)),c=v(t*n),{value:u}=S(v(f*c**2n)),a=v(u*f),l=v(u*c),d=v(a*l*i);let h;g(i*d)?([t,n]=[v(n*o),v(t*o)],h=v(a*s)):h=l,g(t*d)&&(n=v(-n));let p=v((r-n)*h);return g(p)&&(p=v(-p)),w(p,e)}equals(t){const n=t,[e,r,o,i]=[this.t,n.t,this.z,n.z];return v(e*i)===v(r*o)}negate(){return new u(v(-this.x),this.y,this.z,v(-this.t))}double(){const t=this.x,e=this.y,r=this.z,{a:o}=n,i=v(t**2n),s=v(e**2n),f=v(2n*r**2n),c=v(o*i),a=v((t+e)**2n-i-s),l=v(c+s),d=v(l-f),h=v(c-s),p=v(a*d),y=v(l*h),w=v(a*h),g=v(d*l);return new u(p,y,g,w)}add(t){const n=this.x,e=this.y,r=this.z,o=this.t,i=t.x,s=t.y,f=t.z,c=t.t,a=v((e-n)*(s+i)),l=v((e+n)*(s-i)),d=v(l-a);if(0n===d)return this.double();const h=v(2n*r*c),p=v(2n*o*f),y=v(p+h),w=v(l+a),g=v(p-h),b=v(y*d),m=v(w*g),x=v(y*g),E=v(d*w);return new u(b,m,E,x)}subtract(t){return this.add(t.negate())}multiplyUnsafe(t){if(!b(t))throw new TypeError("Point#multiply: expected number or bigint");let e=v(BigInt(t),n.n);if(1n===e)return this;let r=u.ZERO,o=this;for(;e>0n;)1n&e&&(r=r.add(o)),o=o.double(),e>>=1n;return r}precomputeWindow(t){const n=256/t+1;let e=[],r=this,o=r;for(let i=0;i<n;i++){o=r,e.push(o);for(let n=1;n<2**(t-1);n++)o=o.add(r),e.push(o);r=o.double()}return e}wNAF(t,n){!n&&this.equals(u.BASE)&&(n=l.BASE);const e=n&&n._WINDOW_SIZE||1;if(256%e)throw new Error("Point#wNAF: Invalid precomputation window, must be power of 2");let r=n&&a.get(n);r||(r=this.precomputeWindow(e),n&&1!==e&&(r=u.normalizeZ(r),a.set(n,r)));let o=u.ZERO,i=u.ZERO;const s=256/e+1,f=2**(e-1),c=BigInt(2**e-1),d=2**e,h=BigInt(e);for(let n=0;n<s;n++){const e=n*f;let s=Number(t&c);if(t>>=h,s>f&&(s-=d,t+=1n),0===s)i=i.add(n%2?r[e].negate():r[e]);else{const t=r[e+Math.abs(s)-1];o=o.add(s<0?t.negate():t)}}return[o,i]}multiply(t,e){if(!b(t))throw new TypeError("Point#multiply: expected number or bigint");const r=v(BigInt(t),n.n);return u.normalizeZ(this.wNAF(r,e))[0]}toAffine(t=E(this.z)){const n=v(this.x*t),e=v(this.y*t);return new l(n,e)}}t.ExtendedPoint=u,u.BASE=new u(n.Gx,n.Gy,1n,v(n.Gx*n.Gy)),u.ZERO=new u(0n,1n,1n,0n);const a=new WeakMap;class l{constructor(t,n){this.x=t,this.y=n}_setWindowSize(t){this._WINDOW_SIZE=t,a.delete(this)}static fromHex(t){const{d:e,P:r}=n,o=t instanceof Uint8Array?t:p(t);if(32!==o.length)throw new Error("Point.fromHex: expected 32 bytes");const i=o[31],s=-129&i,f=0!=(128&i),c=m(Uint8Array.from(Array.from(o.slice(0,31)).concat(s)));if(c>=r)throw new Error("Point.fromHex expects hex <= Fp");const u=v(c*c),a=v(u-1n),d=v(e*u+1n);let{isValid:h,value:y}=B(a,d);if(!h)throw new Error("Point.fromHex: invalid y coordinate");return f!==(1n===(1n&y))&&(y=v(-y)),new l(y,c)}static async fromPrivateKey(n){const e=await t.utils.sha512(k(n));return l.BASE.multiply(P(e))}toRawBytes(){const t=y(this.y),n=new Uint8Array(e);for(let r=t.length-2,o=0;o<e&&r>=0;r-=2,o++)n[o]=Number.parseInt(t[r]+t[r+1],16);const r=1n&this.x?128:0;return n[31]|=r,n}toHex(){return h(this.toRawBytes())}toX25519(){return v((1n+this.y)*E(1n-this.y))}equals(t){return this.x===t.x&&this.y===t.y}negate(){return new l(v(-this.x),this.y)}add(t){return u.fromAffine(this).add(u.fromAffine(t)).toAffine()}subtract(t){return this.add(t.negate())}multiply(t){return u.fromAffine(this).multiply(t,this).toAffine()}}t.Point=l,l.BASE=new l(n.Gx,n.Gy),l.ZERO=new l(0n,1n);class d{constructor(t,n){this.r=t,this.s=n}static fromHex(t){t=I(t);const e=l.fromHex(t.slice(0,32)),r=m(t.slice(32));if(!(0<(o=r)&&o<n.n))throw new Error("Signature.fromHex expects s <= CURVE.n");var o;return new d(e,r)}toRawBytes(){const t=p(y(this.s)).reverse(),n=new Uint8Array(e);n.set(t);const r=new Uint8Array(64);return r.set(this.r.toRawBytes()),r.set(n,32),r}toHex(){return h(this.toRawBytes())}}function h(t){let n="";for(let e=0;e<t.length;e++)n+=t[e].toString(16).padStart(2,"0");return n}function p(t){if("string"!=typeof t)throw new TypeError("hexToBytes: expected string, got "+typeof t);if(t.length%2)throw new Error("hexToBytes: received invalid unpadded hex");const n=new Uint8Array(t.length/2);for(let e=0;e<n.length;e++){const r=2*e;n[e]=Number.parseInt(t.slice(r,r+2),16)}return n}function y(t){const n=t.toString(16);return 1&n.length?`0${n}`:n}function w(t,n=32){return p(y(t).padStart(2*n,"0")).reverse()}function g(t){return 1n===(1n&v(t))}function b(t){return"bigint"==typeof t&&t>0n||!!("number"==typeof t&&t>0&&Number.isSafeInteger(t))}function m(t){let n=0n;for(let e=0;e<t.length;e++)n+=BigInt(t[e])<<8n*BigInt(e);return n}function x(t){return v(m(t)&2n**255n-1n)}function v(t,e=n.P){const r=t%e;return r>=0n?r:e+r}function E(t,e=n.P){if(0n===t||e<=0n)throw new Error(`invert: expected positive integers, got n=${t} mod=${e}`);let r=v(t,e),o=e,[i,s,f,c]=[0n,1n,1n,0n];for(;0n!==r;){const t=o/r,n=o%r,e=i-f*t,u=s-c*t;[o,r]=[r,n],[i,s]=[f,c],[f,c]=[e,u]}if(1n!==o)throw new Error("invert: does not exist");return v(i,e)}function A(t,e){const{P:r}=n;let o=t;for(;e-- >0n;)o*=o,o%=r;return o}function B(t,e){const r=v(e*e*e),i=v(r*r*e);let s=v(t*r*function(t){const{P:e}=n,r=t*t%e*t%e,o=A(r,2n)*r%e,i=A(o,1n)*t%e,s=A(i,5n)*i%e,f=A(s,10n)*s%e,c=A(f,20n)*f%e,u=A(c,40n)*c%e,a=A(u,80n)*u%e,l=A(a,80n)*u%e,d=A(l,10n)*s%e;return A(d,2n)*t%e}(t*i));const f=v(e*s*s),c=s,u=v(s*o),a=f===t,l=f===v(-t),d=f===v(-t*o);return a&&(s=c),(l||d)&&(s=u),g(s)&&(s=v(-s)),{isValid:a||l,value:s}}function S(t){return B(1n,t)}async function R(...e){const r=function(...t){if(1===t.length)return t[0];const n=t.reduce(((t,n)=>t+n.length),0),e=new Uint8Array(n);for(let n=0,r=0;n<t.length;n++){const o=t[n];e.set(o,r),r+=o.length}return e}(...e);return v(m(await t.utils.sha512(r)),n.n)}function P(t){const r=t.slice(0,e);return r[0]&=248,r[31]&=127,r[31]|=64,v(m(r),n.n)}function I(t){return t instanceof Uint8Array?t:p(t)}function k(t){let n;if("bigint"==typeof t||"number"==typeof t&&Number.isSafeInteger(t)){if(n=BigInt(t),n<0n||n>2n**256n)throw new Error("Expected 32 bytes of private key");t=n.toString(16).padStart(64,"0")}if("string"==typeof t){if(64!==t.length)throw new Error("Expected 32 bytes of private key");return p(t)}if(t instanceof Uint8Array){if(32!==t.length)throw new Error("Expected 32 bytes of private key");return t}throw new TypeError("Expected valid private key")}t.Signature=d,t.SignResult=d,t.getPublicKey=async function(t){const n=await l.fromPrivateKey(t);return"string"==typeof t?n.toHex():n.toRawBytes()},t.sign=async function(r,o){const i=await t.utils.sha512(k(o)),s=P(i),f=l.BASE.multiply(s),c=I(r),u=await R((a=i,a.slice(e)),c);var a;const h=l.BASE.multiply(u),p=v(u+await R(h.toRawBytes(),f.toRawBytes(),c)*s,n.n),y=new d(h,p);return"string"==typeof r?y.toHex():y.toRawBytes()},t.verify=async function(t,n,e){n=I(n),e instanceof l||(e=l.fromHex(e)),t instanceof d||(t=d.fromHex(t));const r=await R(t.r.toRawBytes(),e.toRawBytes(),n),o=u.fromAffine(e).multiplyUnsafe(r),i=u.BASE.multiply(t.s);return u.fromAffine(t.r).add(o).subtract(i).multiplyUnsafe(8n).equals(u.ZERO)},l.BASE._setWindowSize(8),t.utils={TORSION_SUBGROUP:["0100000000000000000000000000000000000000000000000000000000000000","c7176a703d4dd84fba3c0b760d10670f2a2053fa2c39ccc64ec7fd7792ac037a","0000000000000000000000000000000000000000000000000000000000000080","26e8958fc2b227b045c3f489f2ef98f0d5dfac05d3c63339b13802886d53fc05","ecffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff7f","26e8958fc2b227b045c3f489f2ef98f0d5dfac05d3c63339b13802886d53fc85","0000000000000000000000000000000000000000000000000000000000000000","c7176a703d4dd84fba3c0b760d10670f2a2053fa2c39ccc64ec7fd7792ac03fa"],randomPrivateKey:(t=32)=>{if("object"==typeof self&&"crypto"in self)return self.crypto.getRandomValues(new Uint8Array(t));if("object"==typeof process&&"node"in process.versions){const{randomBytes:n}=r.default;return new Uint8Array(n(t).buffer)}throw new Error("The environment doesn't have randomBytes function")},sha512:async t=>{if("object"==typeof self&&"crypto"in self){const n=await self.crypto.subtle.digest("SHA-512",t.buffer);return new Uint8Array(n)}if("object"==typeof process&&"node"in process.versions){const{createHash:n}=r.default,e=n("sha512");return e.update(t),Uint8Array.from(e.digest())}throw new Error("The environment doesn't have sha512 function")},precompute(t=8,n=l.BASE){const e=n.equals(l.BASE)?n:new l(n.x,n.y);return e._setWindowSize(t),e.multiply(1n),e}}}(f);var c="object"==typeof window;function u(t){function n(t){return t.replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}return n(c?window.btoa(t):Buffer.from(t||"utf8").toString("base64"))}function a(t,n,e){return i(this,void 0,void 0,(function(){var r,o,i,c,a;return s(this,(function(s){switch(s.label){case 0:return r={alg:"EdDSA",typ:t},o=u(JSON.stringify(r))+"."+u(JSON.stringify(n)),i=(new TextEncoder).encode(o),[4,f.sign(i,e)];case 1:return c=s.sent(),l=c,a=u(Array.from(l).map((function(t){return String.fromCharCode(t)})).join("")),[2,o+"."+a]}var l}))}))}var l=function(){function t(t){this.key=t}return t.prototype.build=function(){var t=this.app?{app:this.app.id}:{},n=this.user?{uid:this.user.id,gid:this.user.groupId}:{},e=this.capture?{gid:this.capture.groupId,uids:this.capture.userIds?this.capture.userIds.join():void 0}:{},r=this.access?{did:this.access.dataId,gid:this.access.groupId}:{},i=o(o(o(o(o({},t),n),e),r),{tid:"test",exp:Math.floor(Date.now()/1e3)+(this.lifetime||3600)});return Object.keys(i).forEach((function(t){return void 0===i[t]&&delete i[t]})),a(this.capture?"tjwt":this.access?"nejwt":"jwt",i,this.key)},t}(),d=function(){function t(t){this.token=t}return t.init=function(n){var e,r="string"==typeof n?(e=n,c?Uint8Array.from(window.atob(e),(function(t){return t.charCodeAt(0)})):Buffer.from(e,"base64")).slice(0,32):n;return new t(new l(r))},t.prototype.build=function(){return this.token.build()},t.prototype.lifetime=function(t){return this.token.lifetime=t,this},t.prototype.forApp=function(t){var n=this;return n.token.app={id:t},{forUser:{withId:function(t){return n.token.user={id:t},{inGroup:function(t){return n.token.user.groupId=t,n}}}},toCaptureData:{forGroup:function(t){return n.token.capture={groupId:t},n},forUsers:function(t){return n.token.capture={userIds:t},n}},toAccessData:{withId:function(t){n.token.access={dataId:t}},inGroup:function(t){n.token.access={groupId:t}}}}},t}();t.TokenBuilder=d,Object.defineProperty(t,"__esModule",{value:!0})}));
